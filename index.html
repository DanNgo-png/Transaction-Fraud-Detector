<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Fraud Detector</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        :root {
            --primary-color: #4A90E2;
            --secondary-color: #E6F0F9;
            --text-color: #333;
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --border-color: #DDE2E7;
            --danger-color: #E74C3C;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 5px;
        }

        p {
            font-size: 1rem;
            color: #555;
            text-align: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #444;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }

        textarea:focus, input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--secondary-color);
            outline: none;
        }

        button {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            background-color: #3870b3;
        }

        button:active {
            transform: scale(0.99);
        }

        .results {
            margin-top: 20px;
        }

        .results h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        #suspicious-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .suspicious-item {
            background-color: #FEF3F2;
            border: 1px solid #FBCAC6;
            color: var(--danger-color);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .suspicious-item strong {
            font-weight: 600;
        }

        .suspicious-item span {
            font-size: 0.9rem;
            color: #888;
        }

        .no-results {
            text-align: center;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: #888;
            font-style: italic;
        }

        .benford-chart {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }

        .benford-chart h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            height: 150px;
            gap: 10px; /* Adjusted for better spacing */
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
        }

        .bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: calc(100% / 9);
            position: relative; /* Added for positioning context */
        }

        .bar-pair-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            width: 100%;
            height: 100%;
        }

        .bar {
            width: 45%; /* Adjust width to fit two bars */
            background-color: var(--primary-color);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
        }

        .bar.expected {
            background-color: var(--danger-color);
            opacity: 0.6;
        }

        .bar-label {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 600;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 4px;
        }

        .legend-color.actual {
            background-color: var(--primary-color);
        }

        .legend-color.expected {
            background-color: var(--danger-color);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
        
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
            margin-bottom: 10px;
        }

        .drop-zone.active {
            background-color: var(--secondary-color);
            border-color: var(--primary-color);
        }

        .drop-zone-text {
            font-size: 1rem;
            color: #888;
            margin-bottom: 10px;
        }

        /* Modal for error messages */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transaction Fraud Detector</h1>
        <p>
            Paste your transaction data or drag and drop an Excel file to analyze for suspicious entries. The tool will apply simplified versions of Benford's Law and statistical outlier detection to flag potential anomalies.
        </p>

        <div class="input-group">
            <div class="form-section">
                <label for="dataset">Transaction Dataset (JSON format)</label>
                <!-- Drag-and-drop zone -->
                <div id="drop-zone" class="drop-zone">
                    <p class="drop-zone-text">Drag and drop an Excel file here</p>
                    <p style="font-size: 0.9rem; color: #aaa; margin-bottom: 10px;">or</p>
                    <textarea id="dataset" rows="10" placeholder='Example: [{"id": 1, "amount": 120.50}, {"id": 2, "amount": 2345.00}, {"id": 3, "amount": 9999.00}, {"id": 4, "amount": 1.23}, {"id": 5, "amount": 543.21}, {"id": 6, "amount": 1000.00}]'></textarea>
                </div>
            </div>
            <div class="form-section">
                <label for="columnName">Column to scan (e.g., "amount")</label>
                <input type="text" id="columnName" value="amount" placeholder="Enter column name">
            </div>
            <button onclick="runAnalysis()">Run Analysis</button>
        </div>

        <div class="results" id="results-section" style="display: none;">
            <div class="benford-chart">
                <h3>Benford's Law Distribution</h3>
                <p style="font-size: 0.8rem; text-align: left;">
                    The bar chart below shows the frequency of the first digit in your dataset (blue) versus the theoretical distribution according to Benford's Law (red). Significant deviations may indicate data manipulation.
                </p>
                <div class="bar-chart">
                    <!-- Bars will be generated by JavaScript -->
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color actual"></div>
                        <span>Actual Frequency</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color expected"></div>
                        <span>Expected (Benford's Law)</span>
                    </div>
                </div>
            </div>
            <h2>Suspicious Entries</h2>
            <ul id="suspicious-list"></ul>
        </div>
    </div>

    <!-- Error/Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>

    <script>
        // Data for theoretical Benford's Law distribution
        const BENFORD_DISTRIBUTION = [0, 30.1, 17.6, 12.5, 9.7, 7.9, 6.7, 5.8, 5.1, 4.6]; // Index 0 is ignored
        
        // Modal functions
        function showModal(message) {
            const modal = document.getElementById('infoModal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('infoModal');
            modal.style.display = 'none';
        }

        // Drag-and-drop file handling
        const dropZone = document.getElementById('drop-zone');
        const datasetTextarea = document.getElementById('dataset');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        datasetTextarea.value = JSON.stringify(json, null, 2);
                        showModal('Excel file successfully loaded and converted to JSON. Click "Run Analysis" to proceed.');

                    } catch (error) {
                        console.error("Error processing file:", error);
                        showModal(`Could not read file: ${error.message}. Please ensure it is a valid Excel file.`);
                    }
                };
                reader.onerror = (error) => {
                    console.error("Error reading file:", error);
                    showModal('An error occurred while reading the file.');
                };
                reader.readAsArrayBuffer(file);
            }
        });


        function runAnalysis() {
            const datasetText = document.getElementById('dataset').value;
            const columnName = document.getElementById('columnName').value.trim();
            const resultsSection = document.getElementById('results-section');
            const suspiciousList = document.getElementById('suspicious-list');

            resultsSection.style.display = 'block';
            suspiciousList.innerHTML = '';
            
            let data;
            try {
                data = JSON.parse(datasetText);
                if (!Array.isArray(data) || data.length === 0) {
                    showModal("Invalid or empty JSON data provided.");
                    return;
                }
            } catch (e) {
                showModal(`Invalid JSON data provided. Please ensure your data is in the correct JSON array format.`);
                return;
            }

            // Get numeric values from the specified column
            const values = data.map(item => item[columnName]).filter(v => typeof v === 'number' && v > 0);

            if (values.length === 0) {
                suspiciousList.innerHTML = `<li class="no-results">No valid numeric data found in the "${columnName}" column.</li>`;
                return;
            }

            const flaggedItems = new Set();
            const fullResults = data.map(item => ({ ...item, flags: new Set() }));

            // --- Benford's Law Analysis (Simplified) ---
            const leadingDigits = values.map(v => parseInt(String(v).charAt(0)));
            const digitCounts = Array(10).fill(0);
            leadingDigits.forEach(d => digitCounts[d]++);
            
            const totalCount = leadingDigits.length;
            const digitFrequencies = digitCounts.map(count => (count / totalCount) * 100);

            const barChartContainer = document.querySelector('.bar-chart');
            barChartContainer.innerHTML = '';
            let chartHtml = '';

            for (let i = 1; i <= 9; i++) {
                const actualHeight = digitFrequencies[i] || 0; // Use 0 if no value exists
                const expectedHeight = BENFORD_DISTRIBUTION[i];

                chartHtml += `
                    <div class="bar-container">
                        <div class="bar-pair-container">
                            <div class="bar expected" style="height: ${expectedHeight}%;" title="Expected: ${expectedHeight.toFixed(1)}%"></div>
                            <div class="bar" style="height: ${actualHeight}%;" title="Actual: ${actualHeight.toFixed(1)}%"></div>
                        </div>
                        <div class="bar-label">${i}</div>
                    </div>
                `;
                
                // Flag items that deviate significantly from Benford's law
                if (Math.abs(actualHeight - expectedHeight) > 10) { // Simple threshold for flagging
                    data.forEach((item, index) => {
                        if (String(item[columnName]).startsWith(String(i))) {
                            fullResults[index].flags.add('Benford');
                        }
                    });
                }
            }
            barChartContainer.innerHTML = chartHtml;


            // --- Statistical Outlier (Z-score) Analysis ---
            const mean = values.reduce((sum, v) => sum + v, 0) / values.length;
            const stdDev = Math.sqrt(values.map(v => Math.pow(v - mean, 2)).reduce((sum, v) => sum + v, 0) / values.length);
            
            values.forEach((value, index) => {
                if (stdDev > 0) {
                    const zScore = Math.abs((value - mean) / stdDev);
                    if (zScore > 2.5) { // Common Z-score threshold for outliers
                        fullResults[index].flags.add('Outlier');
                    }
                }
            });

            // --- Simulated Clustering-based Outlier Detection ---
            // This is a simplified heuristic. In a real scenario, a full clustering algorithm (like DBSCAN or K-means) would be used.
            // Here, we'll flag any transaction that is a large, isolated value with no similar, proximate values.
            const sortedValues = [...values].sort((a, b) => a - b);
            const valueMap = new Map();
            sortedValues.forEach((val) => {
                if (!valueMap.has(val)) valueMap.set(val, []);
                valueMap.get(val).push(val);
            });

            sortedValues.forEach((value, index) => {
                if (value > mean * 2 && valueMap.get(value).length === 1) {
                    let hasNearbyValue = false;
                    for (let i = index - 1; i <= index + 1; i++) {
                        if (i >= 0 && i < sortedValues.length && i !== index) {
                            if (Math.abs(sortedValues[i] - value) / value < 0.1) { // Check for values within 10%
                                hasNearbyValue = true;
                                break;
                            }
                        }
                    }
                    if (!hasNearbyValue) {
                         const originalIndex = data.findIndex(item => item[columnName] === value);
                         if (originalIndex !== -1) {
                            fullResults[originalIndex].flags.add('Clustering');
                         }
                    }
                }
            });

            // Display results
            fullResults.forEach((item, index) => {
                if (item.flags.size > 0) {
                    const listItem = document.createElement('li');
                    listItem.className = 'suspicious-item';
                    
                    let flagText = Array.from(item.flags).join(', ');
                    
                    listItem.innerHTML = `
                        <strong>Entry: ${JSON.stringify(item)}</strong>
                        <span>Flagged for: ${flagText}</span>
                    `;
                    suspiciousList.appendChild(listItem);
                }
            });

            if (suspiciousList.children.length === 0) {
                suspiciousList.innerHTML = `<li class="no-results">No suspicious entries were flagged.</li>`;
            }
        }
    </script>
</body>
</html>
